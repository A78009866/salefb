{% extends 'social/base.html' %}
{% load static %}
{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <!-- Create Post Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="{% url 'create_post' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group mb-3">
                        <textarea class="form-control bg-light text-dark" name="content" rows="3" placeholder="What's on your mind?"></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <label for="image-upload" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-image"></i> Photo
                            </label>
                            <input id="image-upload" type="file" name="image" accept="image/*" style="display: none;">
                            
                            <label for="video-upload" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-video"></i> Video
                            </label>
                            <input id="video-upload" type="file" name="video" accept="video/*" style="display: none;">
                        </div>
                        <button type="submit" class="btn btn-primary">Post</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Posts Feed -->
        {% for post in posts %}
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex align-items-center mb-3">
                    <a href="{% url 'profile' post.user.username %}">
                        <img src="{{ post.user.profile_picture.url }}" class="rounded-circle me-2 border" alt="User avatar" 
                            onerror="this.onerror=null; this.src='/media/profile_pics/default_profile.png';"
                            style="width: 50px; height: 50px; object-fit: cover;">
                    </a>
                    <div>
                        <a href="{% url 'profile' post.user.username %}" class="text-decoration-none text-dark">
                            <h5 class="mb-0">@{{ post.user.username }}</h5>
                        </a>
                        <small class="text-muted">{{ post.created_at|timesince }} ago</small>
                    </div>
                </div>
                
                <p class="card-text mb-3">{{ post.content }}</p>
                
                {% if post.image %}
                <img src="{{ post.image.url }}" class="img-fluid mb-3 rounded" alt="Post image">
                {% endif %}
                
                {% if post.video %}
                <div class="video-container mb-3 rounded">
                    <video 
                        controls 
                        playsinline 
                        preload="metadata" 
                        poster="{% if post.image %}{{ post.image.url }}{% else %}{% static 'default-video-thumbnail.jpg' %}{% endif %}"
                        class="lazy-video"
                        data-src="{{ post.video.url }}"
                    >
                        <source src="{{ post.video.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="likes-count-{{ post.id }}">{{ post.likes.count }}</span> likes
                    </div>
                    <div>
                        <h7 href="#" data-bs-toggle="modal" data-bs-target="#commentsModal-{{ post.id }}">
                            {{ post.comments.count }} comments
                        </h7>
                    </div>
                </div>
                
                <hr>
                
                <div class="post-actions d-flex justify-content-around">
                    <a href="#" class="like-btn" data-post-id="{{ post.id }}">
                        <i class="like-icon-{{ post.id }} {% if post.is_liked %}fas fa-heart text-danger{% else %}far fa-heart{% endif %}"></i>
                    </a>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#commentsModal-{{ post.id }}">
                        <i class="far fa-comment"></i>
                    </a>
                    <a href="#" class="save-btn" data-post-id="{{ post.id }}">
    <i class="save-icon-{{ post.id }} {% if post.is_saved %}fas fa-bookmark text-warning{% else %}far fa-bookmark{% endif %}"></i>
</a>
                </div>
            </div>
        </div>

        <!-- Comments Modal -->
        <div class="modal fade" id="commentsModal-{{ post.id }}" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="commentsModalLabel">Comments</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="comments-container" style="max-height: 400px; overflow-y: auto;">
                            {% for comment in post.comments.all %}
                            <div class="d-flex mb-3">
                                <a href="{% url 'profile' comment.user.username %}">
                                    <img src="{{ comment.user.profile_picture.url }}" class="rounded-circle me-2 border" 
                                        style="width: 40px; height: 40px; object-fit: cover;"
                                        onerror="this.onerror=null; this.src='/media/profile_pics/default_profile.png';"
                                        alt="{{ comment.user.username }}">
                                </a>
                                <div>
                                    <div class="d-flex align-items-center">
                                        <a href="{% url 'profile' comment.user.username %}" class="text-decoration-none text-dark me-2">
                                            <strong>@{{ comment.user.username }}</strong>
                                        </a>
                                        <small class="text-muted">{{ comment.created_at|timesince }} ago</small>
                                    </div>
                                    <p class="mb-0">{{ comment.content }}</p>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-muted text-center">No comments yet</p>
                            {% endfor %}
                        </div>
                        <form id="comment-form-{{ post.id }}" class="comment-form mt-3" action="{% url 'add_comment' post.id %}" method="POST">
                            {% csrf_token %}
                            <div class="input-group">
                                <input type="text" class="form-control bg-light text-dark" name="content" placeholder="Write a comment...">
                                <button class="btn btn-outline-primary" type="submit">Post</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<style>
    .video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
        overflow: hidden;
        background: #000;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        background: #000;
    }
    
    video {
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    video:hover {
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .profile-pic {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .like-animation {
        animation: pulse 0.3s ease;
        transform-origin: center;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
    }

    /* Custom scrollbar for comments */
    .comments-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .comments-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .comments-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    
    .comments-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-btn');
    likeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = this.getAttribute('data-post-id');
            const likeIcon = document.querySelector(`.like-icon-${postId}`);
            const likesCount = document.querySelector(`.likes-count-${postId}`);

            // إضافة مؤثرات بصرية
            likeIcon.classList.add('like-animation');
            setTimeout(() => {
                likeIcon.classList.remove('like-animation');
            }, 300);

            // باقي الكود...
        });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Like buttons functionality
    const likeButtons = document.querySelectorAll('.like-btn');
    likeButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = this.getAttribute('data-post-id');
            const likeIcon = document.querySelector(`.like-icon-${postId}`);
            const likesCount = document.querySelector(`.likes-count-${postId}`);

            // تأثير بصري فوري
            likeIcon.classList.add('like-animation');
            setTimeout(() => {
                likeIcon.classList.remove('like-animation');
            }, 300)

            // تغيير الحالة فورياً قبل انتظار الرد من السيرفر
            const isLiked = likeIcon.classList.contains('far');
            if (isLiked) {
                likeIcon.classList.remove('far');
                likeIcon.classList.add('fas', 'text-danger');
                likesCount.textContent = parseInt(likesCount.textContent) + 1;
            } else {
                likeIcon.classList.remove('fas', 'text-danger');
                likeIcon.classList.add('far');
                likesCount.textContent = parseInt(likesCount.textContent) - 1;
            }

            // إرسال الطلب إلى السيرفر
            fetch(`/post/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            })
            .then(response => response.json())
            .then(data => {
                // إذا كان هناك اختلاف بين الحالة المحلية والرد من السيرفر
                if ((data.liked && !likeIcon.classList.contains('fas')) || 
                    (!data.liked && likeIcon.classList.contains('fas'))) {
                    if (data.liked) {
                        likeIcon.classList.remove('far');
                        likeIcon.classList.add('fas', 'text-danger');
                        likesCount.textContent = data.likes_count;
                    } else {
                        likeIcon.classList.remove('fas', 'text-danger');
                        likeIcon.classList.add('far');
                        likesCount.textContent = data.likes_count;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // في حالة الخطأ، نعيد الحالة إلى ما كانت عليه
                if (isLiked) {
                    likeIcon.classList.remove('fas', 'text-danger');
                    likeIcon.classList.add('far');
                    likesCount.textContent = parseInt(likesCount.textContent) - 1;
                } else {
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas', 'text-danger');
                    likesCount.textContent = parseInt(likesCount.textContent) + 1;
                }
            });
        });
    });

    // Video lazy loading and auto-play when visible
    const lazyVideos = document.querySelectorAll('.lazy-video');
    
    const videoObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const video = entry.target;
                video.src = video.getAttribute('data-src');
                
                // Auto-play when 50% of video is visible
                const playPromise = video.play();
                
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        // Auto-play was prevented, show controls
                        video.controls = true;
                    });
                }
                
                observer.unobserve(video);
            }
        });
    }, { threshold: 0.5 });

    lazyVideos.forEach(video => {
        videoObserver.observe(video);
    });

    // Pause other videos when one is playing
    document.querySelectorAll('video').forEach(video => {
        video.addEventListener('play', function() {
            document.querySelectorAll('video').forEach(otherVideo => {
                if (otherVideo !== video && !otherVideo.paused) {
                    otherVideo.pause();
                }
            });
        });
        
        // Show controls on hover
        video.addEventListener('mouseenter', function() {
            this.controls = true;
        });
        
        video.addEventListener('mouseleave', function() {
            if (!this.paused) this.controls = false;
        });
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            const postId = this.getAttribute('action').split('/')[2]; // استخراج post id
            const input = this.querySelector('input[name="content"]');
            const commentContent = input.value.trim();

            if (commentContent === '') return;

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'content': commentContent
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = this.closest('.modal-body').querySelector('.comments-container');

                    // إضافة التعليق الجديد
                    const newComment = document.createElement('div');
                    newComment.classList.add('d-flex', 'mb-3');
                    newComment.innerHTML = `
                        <a href="/profile/${data.username}">
                            <img src="${data.profile_picture}" class="rounded-circle me-2 border"
                                style="width: 40px; height: 40px; object-fit: cover;"
                                onerror="this.onerror=null; this.src='/media/profile_pics/default_profile.png';"
                                alt="${data.username}">
                        </a>
                        <div>
                            <div class="d-flex align-items-center">
                                <a href="/profile/${data.username}" class="text-decoration-none text-dark me-2">
                                    <strong>@${data.username}</strong>
                                </a>
                                <small class="text-muted">just now</small>
                            </div>
                            <p class="mb-0">${data.content}</p>
                        </div>
                    `;

                    container.prepend(newComment); // أضف التعليق في الأعلى
                    input.value = ''; // مسح الحقل
                }
            });
        });
    });
});
</script>

{% endblock %}
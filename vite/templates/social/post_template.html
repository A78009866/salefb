{% load static %}

<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex align-items-center mb-3">
            <a href="{% url 'profile' post.user.username %}">
                <img src="{{ post.user.profile_picture.url }}" class="rounded-circle me-2 border" alt="User avatar" 
                    onerror="this.onerror=null; this.src='/media/profile_pics/default_profile.png';"
                    style="width: 50px; height: 50px; object-fit: cover;">
            </a>
            <div>
                <a href="{% url 'profile' post.user.username %}" class="text-decoration-none text-dark">
                    <h5 class="mb-0">@{{ post.user.username }}</h5>
                </a>
                <small class="text-muted">{{ post.created_at|timesince }} مضت</small>
            </div>
           {% if post.user == request.user %}
<div class="dropdown ms-auto">
    <button class="btn btn-sm btn-light" type="button" id="postOptionsDropdown-{{ post.id }}" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-ellipsis-v"></i>
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="postOptionsDropdown-{{ post.id }}">
        <li><a class="dropdown-item" href="{% url 'edit_post' post.id %}"><i class="fas fa-edit me-2"></i>تعديل</a></li>
        <li><a class="dropdown-item text-danger" href="{% url 'delete_post' post.id %}"><i class="fas fa-trash-alt me-2"></i>حذف</a></li>
    </ul>
</div>
{% endif %}

        </div>
        
        <p class="card-text mb-3">{{ post.content }}</p>
        
        {% if post.image %}
        <img src="{{ post.image.url }}" class="img-fluid mb-3 rounded" alt="Post image">
        {% endif %}
        
        {% if post.video %}
        <div class="video-container mb-3 rounded">
            <video 
                controls 
                playsinline 
                preload="metadata" 
                poster="{% if post.image %}{{ post.image.url }}{% else %}{% static 'default-video-thumbnail.jpg' %}{% endif %}"
                class="lazy-video"
                data-src="{{ post.video.url }}"
            >
                <source src="{{ post.video.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
        {% endif %}
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <span class="likes-count-{{ post.id }}">{{ post.likes.count }}</span> اعجابات
            </div>
            <div>
                <h7 href="#" data-bs-toggle="modal" data-bs-target="#commentsModal-{{ post.id }}">
                    {{ post.comments.count }} تعليقات
                </h7>
            </div>
        </div>
        
        <hr>
        
        <div class="post-actions d-flex justify-content-around">
            <a href="#" class="like-btn" data-post-id="{{ post.id }}">
                <i class="like-icon-{{ post.id }} {% if post.is_liked %}fas fa-heart text-danger{% else %}far fa-heart{% endif %}"></i>
            </a>
            <a href="#" data-bs-toggle="modal" data-bs-target="#commentsModal-{{ post.id }}">
                <i class="far fa-comment"></i>
            </a>
            <a href="#" class="save-btn" data-post-id="{{ post.id }}">
                <i class="save-icon-{{ post.id }} fas fa-bookmark text-warning"></i>
            </a>
        </div>
        
    </div>
</div>

<!-- Modal للتعليقات -->
<div class="modal fade" id="commentsModal-{{ post.id }}" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentsModalLabel">التعليقات</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="comments-container" style="max-height: 400px; overflow-y: auto;">
                    {% for comment in post.comments.all %}
                    <div class="d-flex mb-3">
                        <a href="{% url 'profile' comment.user.username %}">
                            <img src="{{ comment.user.profile_picture.url }}" class="rounded-circle me-2 border" 
                                style="width: 40px; height: 40px; object-fit: cover;"
                                onerror="this.onerror=null; this.src='/media/profile_pics/default_profile.png';"
                                alt="{{ comment.user.username }}">
                        </a>
                        <div>
                            <div class="d-flex align-items-center">
                                <a href="{% url 'profile' comment.user.username %}" class="text-decoration-none text-dark me-2">
                                    <strong>@{{ comment.user.username }}</strong>
                                </a>
                                <small class="text-muted">{{ comment.created_at|timesince }} مضت</small>
                            </div>
                            <p class="mb-0">{{ comment.content }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center">لا توجد تعليقات حتى الآن</p>
                    {% endfor %}
                </div>
                <form id="comment-form-{{ post.id }}" class="comment-form mt-3" action="{% url 'add_comment' post.id %}" method="POST">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" class="form-control bg-light text-dark" name="content" placeholder="أكتب تعليقا...">
                        <button class="btn btn-outline-primary" type="submit">نشر</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // معالجة إرسال التعليقات
    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const postId = this.id.split('-')[2];
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // إنشاء عنصر التعليق الجديد
                    const commentsContainer = this.closest('.modal-body').querySelector('.comments-container');
                    
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'd-flex mb-3';
                    commentDiv.innerHTML = `
                        <a href="/profile/${data.username}/">
                            <img src="${data.profile_picture}" class="rounded-circle me-2 border" 
                                style="width: 40px; height: 40px; object-fit: cover;"
                                onerror="this.onerror=null; this.src='/media/profile_pics/default_profile.png';"
                                alt="${data.username}">
                        </a>
                        <div>
                            <div class="d-flex align-items-center">
                                <a href="/profile/${data.username}/" class="text-decoration-none text-dark me-2">
                                    <strong>@${data.username}</strong>
                                </a>
                                <small class="text-muted">الآن</small>
                            </div>
                            <p class="mb-0">${data.content}</p>
                        </div>
                    `;
                    
                    // إضافة التعليق الجديد في الأعلى
                    if (commentsContainer.firstChild) {
                        commentsContainer.insertBefore(commentDiv, commentsContainer.firstChild);
                    } else {
                        commentsContainer.appendChild(commentDiv);
                    }
                    
                    // تحديث عدد التعليقات
                    const commentsCountElement = document.querySelector(`[data-bs-target="#commentsModal-${postId}"]`);
                    if (commentsCountElement) {
                        const currentCount = parseInt(commentsCountElement.textContent.trim().split(' ')[0]);
                        commentsCountElement.textContent = `${currentCount + 1} تعليقات`;
                    }
                    
                    // مسح حقل الإدخال
                    this.querySelector('input[name="content"]').value = '';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });
});
</script>